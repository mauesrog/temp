#
# Creates the necessary file for installation i.e. for Mac, a DMG file and for Windows, an EXE file.
#
UNAME := $(shell uname)  # Configure package names.
DIST_NAME = hivebattery_0.0.1
DMG_CONFIG = src/dmg_config/dmg.json
UNAME := $(shell uname)
DIST_NAME = hivebattery_0.0.1
SCRIPTS = src/scripts
RAW_DIST=src/dist

ifeq ($(UNAME),Darwin)  #: Check if the program is running on MacOS or Windows and set up the targets accordingly.
DIST=src/a.dmg
BUILDER=appdmg $(DMG_CONFIG) $(DIST)
FINAL_DIST=$(DIST_NAME).dmg
CREATE_PACKAGE=dummy
PACKAGE_SCRIPT=echo
SPEC=HiveBatteryMacOS.spec
.PHONY: CREATE_PACKAGE
else
DIST=src/a.EXE
BUILDER=iexpress /N /Q $(SCRIPTS)/sed/
FINAL_DIST=$(DIST_NAME).EXE
CREATE_PACKAGE=create-package.SED
PACKAGE_SCRIPT=@python $(SCRIPTS)/python/build_sed.py
SPEC=HiveBatteryWin.spec
endif

.PHONY: all

all: $(FINAL_DIST)

$(RAW_DIST):  #: The DMG/EXE file generated by PyInstaller.
	cd src; pyinstaller $(SPEC)

$(CREATE_PACKAGE):  #: The final DMG/EXE file.
	$(PACKAGE_SCRIPT)

$(DIST): $(RAW_DIST) $(CREATE_PACKAGE)  #: The final DMG/EXE file.
	@echo Successfully created raw $<
	@echo Now creating $@
ifeq ($(UNAME),Darwin)
	$(SCRIPTS)/bash/unmount_stuck_disks.sh && $(BUILDER)
else
	$(BUILDER)$(CREATE_PACKAGE)
endif

$(FINAL_DIST): $(DIST)  #: The "hivebattery_0.0.1.dmg"/"hivebattery_0.0.1.exe" file
	rm -rf $(addprefix src/,build dist) && mkdir src/dist && mv $< src/dist/$@

.PHONY: clean
clean:
	rm -rf $(addprefix src/,build dist $(DIST) $(FINAL_DIST)) $(SCRIPTS)/sed/create-package.SED
ifeq ($(UNAME),Darwin)
	$(SCRIPTS)/bash/unmount_stuck_disks.sh
endif
